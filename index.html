<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modern Contact & Booking Form</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Boxicons for the icons -->
  <link rel='stylesheet' href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css'>
  <!-- Load Poppins font (from login form) -->
  <link rel='stylesheet' href='https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap'>
  
  <style>
    /* Custom styles to ensure Poppins is used and the body is centered */
    * {
        font-family: 'Poppins', sans-serif;
    }
    
    /* Ensure body fills the viewport and uses a soft background */
    body {
        min-height: 100vh;
        background-color: #f3f4f6; /* Light gray background */
    }

    /* Input box for relative positioning of the icon and label */
    .input_box {
        position: relative;
        min-height: 3.5rem; 
    }

    /* Style the input field itself, adapting the login form style */
    .input-field {
        padding: 0.75rem 1rem 0.75rem 2.5rem; /* Padding for the icon */
        transition: border-color 0.3s, box-shadow 0.3s;
        border-color: #e5e7eb;
    }
    .input-field:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 59, 91, 0.3); 
        border-color: #003b5b;
    }

    /* Icon position inside the input box (from login form) */
    .icon {
        position: absolute;
        top: 50%;
        left: 0.75rem;
        transform: translateY(-50%);
        color: #9ca3af; /* Gray-400 */
        font-size: 1.5rem;
        pointer-events: none; /* Icon should not interfere with input interaction */
    }
    
    /* Style for textarea (no inline icon) */
    .textarea-field {
        padding: 0.75rem 1rem;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .textarea-field:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 59, 91, 0.3); 
        border-color: #003b5b;
    }
  </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="wrapper w-full max-w-lg">
        <!-- Message Box (Hidden by default) -->
        <div id="message-box" class="hidden fixed top-4 right-4 z-50 p-4 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 opacity-0" role="alert">
            <!-- Content will be inserted by JavaScript -->
        </div>

        <!-- Form Card (from login_form.html) -->
        <div class="login_box bg-white p-6 md:p-10 rounded-xl shadow-2xl space-y-6">
            
            <!-- Header -->
            <div class="login-header text-center">
                <h4 class="text-3xl font-extrabold text-[#003b5b] mb-2">حجز موعد جديد</h4>
                <p class="text-gray-500 text-base">املأ التفاصيل أدناه لحجز موعدك. يجب أن يكون هناك فاصل ساعة بين المواعيد.</p>
            </div>

            <form method="post" action="" name="contact-form" class="space-y-4 mt-6">
            
                <!-- Input: Name -->
                <div class="input_box">
                    <input type="text" name="your-name" placeholder="الاسم الكامل" required
                           class="input-field w-full border border-gray-300 rounded-lg text-gray-800"
                    >
                    <i class="bx bx-user icon"></i>
                </div>
                
                <!-- Input: Number -->
                <div class="input_box">
                    <input type="tel" name="your-number" placeholder="رقم الهاتف" required
                           class="input-field w-full border border-gray-300 rounded-lg text-gray-800"
                    >
                    <i class="bx bx-phone icon"></i>
                </div>
               

               
                <!-- Input: Email -->
                <div class="input_box">
                    <input type="email" name="your-email" placeholder="البريد الإلكتروني" required
                           class="input-field w-full border border-gray-300 rounded-lg text-gray-800"
                    >
                    <i class="bx bx-envelope icon"></i>
                </div>

                <!-- Date and Time Inputs in a responsive grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Input: Date -->
                    <div class="input_box">
                        <input type="date" name="your-date" required
                               class="input-field w-full border border-gray-300 rounded-lg text-gray-800 pr-3" 
                        >
                        <i class="bx bx-calendar icon"></i>
                    </div>
                    <!-- Input: Time -->
                    <div class="input_box">
                        <input type="time" name="your-time" required
                               class="input-field w-full border border-gray-300 rounded-lg text-gray-800 pr-3"
                        >
                        <i class="bx bx-time-five icon"></i>
                    </div>
                </div>

                <!-- Textarea: Message -->
                <div>
                    <textarea name="message" rows="4" placeholder="وصف موجز للطلب..." required
                              class="textarea-field w-full border border-gray-300 rounded-lg text-gray-800 resize-none"
                    ></textarea>
                </div>

                <!-- Submit Button -->
                <div class="input_box pt-2 h-auto">
                    <button type="submit" id="submit"
                           class="input-submit w-full py-3 bg-orange-500 text-white font-semibold rounded-lg 
                                  hover:bg-orange-600 transition duration-300 shadow-lg cursor-pointer 
                                  focus:outline-none focus:ring-4 focus:ring-orange-300 active:scale-[0.98]">
                        تأكيد الحجز
                    </button>
                </div>
                
                <!-- Availability status (optional, for display) -->
                <div id="availability-status" class="text-center pt-2 text-sm text-gray-600 hidden">
                    <!-- Status will be displayed here -->
                </div>
            </form>
        </div>
    </div>

<script type="module">
    // --- Firebase & Firestore Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables (provided by the environment)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Global references
    let isAuthenticated = false;
    const BOOKINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/bookings`;
    const form = document.forms['contact-form'];
    const messageBox = document.getElementById('message-box');
    const submitButton = document.getElementById('submit');
    
    // --- Google Sheets Submission Setup (Re-integrated) ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyLk3LNqAIGdR5yy_ylJbT_u1q7x1OuJ0IQqJXk47NF-koVS2aBt8QXGyQ6cM9Q9QaiAw/exec';

    /**
     * Authenticates the user using the provided token or anonymously.
     */
    async function initializeAuth() {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            isAuthenticated = true;
            console.log("Firebase initialized and authenticated successfully.");
        } catch (error) {
            console.error("Firebase Auth Error:", error);
            showMessage("خطأ في الاتصال بالنظام. (System connection error.)", 'error');
        }
    }

    /**
     * Shows a custom, transient message box instead of using alert().
     * @param {string} message - The text to display.
     * @param {string} type - 'success' or 'error'.
     */
    function showMessage(message, type = 'success') {
        messageBox.textContent = message;
        
        // Reset classes
        messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-600', 'opacity-0');

        if (type === 'success') {
            messageBox.classList.add('bg-green-600');
        } else {
            messageBox.classList.add('bg-red-500');
        }

        // Show with animation
        messageBox.classList.remove('hidden');
        setTimeout(() => {
            messageBox.classList.add('opacity-100');
        }, 10); // Small delay to trigger transition

        // Hide after 5 seconds
        setTimeout(() => {
            messageBox.classList.remove('opacity-100');
            messageBox.classList.add('opacity-0');
            
            // Wait for transition to complete before hiding fully
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300); 
        }, 5000);
    }
    
    /**
     * Simple Exponential Backoff Retry mechanism for Sheets Submission.
     * @param {FormData} formData - The form data to submit.
     * @param {number} maxRetries - Maximum retry attempts.
     * @param {number} delay - Initial delay in ms.
     */
    async function submitToGoogleScript(formData, maxRetries = 3, delay = 1000) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                console.log("Data successfully logged to Google Sheet (Secondary Log).");
                return response; 
            } catch (error) {
                console.error(`Attempt ${i + 1} to log data to Google Sheet failed:`, error);
                if (i === maxRetries - 1) {
                    throw error; // Throw final error if all retries fail
                }
                // Exponential backoff
                await new Promise(resolve => setTimeout(resolve, delay * (2 ** i))); 
            }
        }
    }

    /**
     * Checks if the requested date and time slot is available, 
     * ensuring a minimum 60-minute gap between bookings (Firestore logic).
     * @param {string} requestedDate - The date string (YYYY-MM-DD).
     * @param {string} requestedTime - The time string (HH:MM).
     * @returns {Promise<boolean>} - True if the slot is available, false otherwise.
     */
    async function isTimeSlotAvailable(requestedDate, requestedTime) {
        if (!isAuthenticated) return false;

        // 1. Convert requested time slot into a start Date object
        const requestedStart = new Date(`${requestedDate}T${requestedTime}:00`);
        if (isNaN(requestedStart)) {
             console.error("Invalid Date/Time Input.");
             return false;
        }

        // 2. Define the requested booking window: 1 hour duration.
        const requestedEnd = new Date(requestedStart.getTime() + 60 * 60 * 1000); // Add 1 hour

        // 3. Define the protection window: an existing booking must not fall 
        //    within 60 minutes of the requested start or end time.
        const protectedStart = new Date(requestedStart.getTime() - 60 * 60 * 1000); // 1 hour before requested start
        const protectedEnd = new Date(requestedEnd.getTime() + 60 * 60 * 1000);   // 1 hour after requested end


        // 4. Query all bookings on the same day from Firestore
        const bookingsRef = collection(db, BOOKINGS_COLLECTION_PATH);
        
        // Note: Firestore queries for date are tricky. We will query only by date string 
        // to simplify, then filter by time in memory.
        const q = query(bookingsRef, where("date", "==", requestedDate));
        
        try {
            const querySnapshot = await getDocs(q);
            
            let isAvailable = true;

            querySnapshot.forEach(doc => {
                const booking = doc.data();
                
                // Get existing booking time strings
                const existingDateStr = booking.date;
                const existingTimeStr = booking.time;
                
                // Convert existing booking to Date objects
                const existingStart = new Date(`${existingDateStr}T${existingTimeStr}:00`);
                if (isNaN(existingStart)) return; 

                // We assume existing bookings also have a 1-hour duration
                const existingEnd = new Date(existingStart.getTime() + 60 * 60 * 1000); 
                
                // The main conflict check:
                
                // Check if the existing booking's start or end time falls within the NEW requested slot's 1-hour buffer
                const existingStartWithinProtectedNewSlot = 
                    existingStart >= protectedStart && existingStart < protectedEnd;
                
                // Check if the new requested slot starts or ends within the EXISTING booking's 1-hour buffer
                const requestedStartWithinProtectedExistingSlot = 
                    requestedStart >= (new Date(existingStart.getTime() - 60 * 60 * 1000)) && requestedStart < (new Date(existingEnd.getTime() + 60 * 60 * 1000));
                
                if (existingStartWithinProtectedNewSlot || requestedStartWithinProtectedExistingSlot) {
                    isAvailable = false;
                    console.log(`Conflict found with booking at ${existingTimeStr} on ${existingDateStr}`);
                }

            });

            return isAvailable;

        } catch (error) {
            console.error("Error fetching bookings:", error);
            return false;
        }
    }


    // --- Main Submission Logic ---

    form.addEventListener('submit', async e => {
        e.preventDefault();
        
        const originalText = submitButton.textContent;
        
        // 1. Basic validation and UI lock
        submitButton.disabled = true;
        submitButton.textContent = 'جاري التحقق...'; // Checking...

        if (!isAuthenticated) {
            showMessage("خطأ: لم يتم تهيئة النظام بشكل صحيح. (System not initialized.)", 'error');
            submitButton.disabled = false;
            submitButton.textContent = originalText;
            return;
        }

        const formData = new FormData(form);
        const requestedDate = formData.get('your-date');
        const requestedTime = formData.get('your-time');

        try {
            // 2. Check for availability (Firestore)
            submitButton.textContent = 'جاري التحقق من التوفر...'; // Checking availability...
            const isAvailable = await isTimeSlotAvailable(requestedDate, requestedTime);

            if (!isAvailable) {
                showMessage("عذراً، هذا الموعد غير متوفر أو يتعارض مع فاصل زمني مطلوب (ساعة واحدة). الرجاء اختيار وقت آخر.", 'error');
                return;
            }

            // 3. Slot is available, proceed to book
            submitButton.textContent = 'جاري الحجز...'; // Booking...
            
            const bookingData = {
                name: formData.get('your-name'),
                phone: formData.get('your-number'),
                email: formData.get('your-email'),
                date: requestedDate,
                time: requestedTime,
                message: formData.get('message'),
                timestamp: new Date().toISOString(),
                bookedBy: auth.currentUser?.uid || 'anonymous'
            };

            // PRIMARY ACTION: Save to Firestore (Availability source)
            await addDoc(collection(db, BOOKINGS_COLLECTION_PATH), bookingData);

            // SECONDARY ACTION: Log to Google Sheet (Non-blocking backup log)
            // We use .catch() so the main success message isn't blocked by Sheets failure
            submitToGoogleScript(formData).catch(err => {
                 console.warn("فشل في تسجيل البيانات في Google Sheet. تم تأكيد الحجز في Firestore. (Failed to log data to Google Sheet. Booking confirmed in Firestore.)", err);
            });
            
            // Success response
            showMessage("تم تأكيد الحجز! سيتم التواصل معك قريباً. (Booking confirmed!)", 'success');
            form.reset();
            
        } catch (error) {
            // Error response
            console.error('Final Submission Error (Firestore):', error);
            showMessage("حدث خطأ أثناء إتمام الحجز. الرجاء المحاولة مرة أخرى.", 'error');
            
        } finally {
            // Re-enable button and restore text
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        }
    });

    // Initialize Firebase Auth on load
    window.onload = initializeAuth;

</script>

</body>
</html>